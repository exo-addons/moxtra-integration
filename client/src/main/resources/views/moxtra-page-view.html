<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <link rel="shortcut icon" href="http://info.moxtra.com/V2/business/images/favicon.png" />
    <link rel="stylesheet" type="text/css" href="/moxtra/skin/exo-moxtra-space.css" />
    <title>Moxtra Pages</title>
  </head>
  <body>
    <div id="moxtra-page-container">
      <div id="moxtra-page-editor" style="display: none;"></div>
      <div id="moxtra-page-progress">
        <span>&{Moxtra.waitConversationPagePreparing}</span><span class='syncingListView'>&nbsp</span>
      </div>
      <div id="moxtra-page-notopen" style="display: none;">
        <span>&{Moxtra.conversationPageNotOpen}</span>
      </div>
    </div>
    <!-- Moxtra JS API global and requires global jQuery -->
    <!-- script type="text/javascript" src="/portal/scripts/4.1.0/SHARED/jquery-min.js"></script -->
    <script type="text/javascript" src="/platform-extension/javascript/jquery-1.7.1.js"></script>
    <script type="text/javascript" src="https://www.moxtra.com/api/js/moxtra-latest.js" id="moxtrajs"></script>
    <script src="/eXoResources/javascript/eXo/core/require.js"></script>
    <script type="text/javascript">
			// RequireJS initialization first
			require.config({
				baseUrl : "/moxtra/js",
				paths : {
					"jquery" : "/platform-extension/javascript/jquery-1.7.1",
					"jqueryUI" : "/moxtra/js/jquery-ui.min",
					"jqueryPnotify" : "/moxtra/js/jquery.pnotify.min"
				},
				shim : {
					"jqueryUI" : ["jquery"],
					"jqueryPnotify" : ["jquery"]
				},
				waitSeconds : 60
			});

			define("exo-moxtra", ["jquery", "jqueryUI", "jqueryPnotify"], function($) {
				// hey nasty thing here: read eXo AMD exo-moxtra.js as text and eval it here to return a module
				var script = "";
				var process = $.ajax({
					async : false,
					type : "GET",
					url : "/moxtra/js/exo-moxtra.js",
					dataType : "text"
				});
				process.done(function(data) {
					script = data;
				});
				process.fail(function(jqXHR, textStatus, e) {
					console.log(textStatus + " " + e);
				});
				return eval(script);
			});

			var pageInitlzr = $.Deferred();

			var user;

			// this func will be called from space window
			function initUser(userName, isAuthorized, authLinkUrl) {
				user = {
					userName : userName,
					isAuthorized : isAuthorized,
					authLinkUrl : authLinkUrl
				};
			}

			function initPage(binderId, pageId) {
				pageInitlzr.resolve(binderId, pageId);
				var hash = "#" + binderId + "/" + pageId;
				if (history.pushState) {
					history.pushState(null, null, hash);
				} else {
					location.hash = hash;
				}
			}

			$(function() {
				// show when page ready

				// check if URL hash has binderId/pageId, use it to show the page
				// otherwise wait until it will be initialized from external
				require(["exo-moxtra"], function(exoMoxtra) {
				  exoMoxtra.moxtrajs(Moxtra);
				  
					function showPage(binderId, pageId) {
						if (user) {
							exoMoxtra.initUser(user.userName, user.isAuthorized, user.authLinkUrl);
						}
						var process = exoMoxtra.initPage(binderId, pageId);
						process.done(function() {
							$("#moxtra-page-editor>div").removeAttr("style");
						});
					}

					if (location.hash) {
						var he = location.hash.split("/");
						var binderId = he[0];
						var hi = binderId.indexOf("#");
						if (hi == 0) {
						  binderId = binderId.slice(1);
						}
						var pageId = he[1];
						showPage(binderId, pageId);
					} else {
						pageInitlzr.done(function(binderId, pageId) {
							// need some delay to let Moxtra JS API prepare
							setTimeout(function() {
								showPage(binderId, pageId);
							}, 1000);
						});
					}
				});
			});
    </script>
  </body>
</html>
